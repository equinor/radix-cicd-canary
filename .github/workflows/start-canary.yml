name: start-canary
on:
  workflow_dispatch:
  push:
    branches:
      - 259748-schedule-scaling-of-cicd-canary

permissions:
  id-token: write

jobs:
  start-canary:
    name: Start radix-cicd-canary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: 'Az CLI login'
        uses: azure/login@v1
        with:
          client-id: 8d20fb80-5c36-4033-af70-832a48dabeaf
          tenant-id: 3aa4a235-b6e2-48d5-9195-7fcf05b459b0
          allow-no-subscriptions: true
      - uses: azure/use-kubelogin@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          kubelogin-version: 'latest'
      - name: 'Download AKS kubeconfig'
        run: |
          az aks get-credentials --name weekly-52 --resource-group clusters --subscription 16ede44b-1f74-40a5-b428-46cca9a5741b --format exec --overwrite-existing
      - name: scale-to-one
        run: |
          az aks command invoke --name weekly-52 --resource-group clusters --command "kubectl scale deployment radix-cicd-canary --replicas=1 -n radix-cicd-canary"